<!DOCTYPE html>
<!--
  ~ Copyright 2023 Thoughtworks, Inc.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<html>
<head>
  <title>服务器 - 正在加载 ...</title>
  <meta charset="utf-8">
  <style type="text/css">
    body {
      margin: 0 auto;
    }

    #logo {
      width: 120px;
      margin: 2em auto;
    }

    #logo svg .st0 {
      fill: black;
    }

    .section-by-status {
      text-align: center;
      font-size: 24px;
      font-family: sans-serif, serif;
      width: 50%;
      margin: 0 auto;
    }

    .section-by-status a {
      text-decoration: none;
    }

    #update-check-message {
      text-align: center;
      font-size: small;
      margin-top: 2em;
    }
  </style>
</head>

<body>

<div id="logo">
  <!-- Copy of: server/src/main/webapp/WEB-INF/rails/app/assets/images/go_logo.svg -->
    <svg t="1682644429680" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8088"
         xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32">
        <path
                d="M343.628456 883.374694c33.940509 15.101735 70.13348 23.650852 106.838374 25.289006a370.171674 370.171674 0 0 0 71.771634 110.984953 400.323951 400.323951 0 0 1-265.483377-53.700745 222.174674 222.174674 0 0 0 86.873369-82.573214zM269.604359 185.111433c0 39.674049 9.470579 76.993251 26.108084 109.551568-77.453982 52.523322-129.414188 138.526421-142.007499 235.279908a206.100285 206.100285 0 0 0-110.984952 37.677548c2.86677-169.497775 94.193871-316.010198 226.986752-389.573564a213.830325 213.830325 0 0 0-0.102385 7.06454z m583.694846 218.437635a329.320202 329.320202 0 0 0-126.342648-9.214618 328.961856 328.961856 0 0 0-64.655902-76.73729 237.481178 237.481178 0 0 0 38.752587-112.469529 445.168425 445.168425 0 0 1 152.245963 198.421437zM813.26681 1023.846423H720.86467l-2.20127-0.255962-1.791731-0.255961-2.20127-0.511923-1.842923-0.511924-2.047693-0.767884a32.763086 32.763086 0 0 1-20.016198-26.312853l-0.255961-2.457232-5.426386-39.008549a261.951107 261.951107 0 0 1-38.80378-21.807928l-5.631155-4.095386-35.988202 14.794581a32.046393 32.046393 0 0 1-41.926511-10.648003l-1.177423-1.945308-45.305204-78.989752a33.121432 33.121432 0 0 1-4.197771-14.282657L512 834.025296a32.814278 32.814278 0 0 1 12.951657-25.80093l1.996501-1.331 30.715392-24.367545-0.6655-6.296655-0.511923-6.60381a205.025246 205.025246 0 0 1-0.102385-25.698545l0.511924-6.501425 0.409538-3.225116 0.409539-3.225116-30.715393-24.316353a32.404739 32.404739 0 0 1-11.569464-41.670549l1.075038-2.047693 45.305204-78.938559a31.892816 31.892816 0 0 1 40.80028-13.821927l2.047693 0.972654 35.681048 14.538619a198.626206 198.626206 0 0 1 38.547818-23.446083l5.887117-2.559616 5.528771-38.906164a32.558316 32.558316 0 0 1 30.203469-31.022547l2.150078-0.102384h91.787831l2.662001 0.255961 2.150078 0.358347 2.559616 0.563115 1.279808 0.460731c11.671849 3.788232 20.476928 14.282658 22.06389 27.029546l0.255962 2.406039 5.426386 39.008548c3.276309 1.53577 6.603809 3.071539 9.828925 4.709694 10.13608 4.965655 19.965005 10.750387 29.179623 17.251812l5.375194 3.890617 36.039394-14.743389a32.046393 32.046393 0 0 1 41.926511 10.648003l1.177424 1.945308 45.305204 78.989752c2.559616 4.504924 3.890616 9.368195 4.19777 14.33385l0.051193 2.713193a32.763086 32.763086 0 0 1-12.951658 25.80093l-1.9965 1.382192-30.715393 24.316353c1.586962 12.490926 2.047693 25.084237 1.331 37.72874l-0.511923 7.371695-0.511923 3.225116-0.358346 3.225116 30.715392 24.367545a32.455932 32.455932 0 0 1 11.569465 41.670549l-1.075039 1.996501-45.305204 78.938559a31.892816 31.892816 0 0 1-40.80028 13.873119l-2.047693-1.023846-35.681048-14.538619a198.677398 198.677398 0 0 1-38.547817 23.446083l-5.887117 2.610808-5.528771 38.906164a32.558316 32.558316 0 0 1-30.20347 31.022547l-2.150077 0.051192z m-42.847973-378.823176c-60.662901-0.511923-110.06349 49.298205-110.626606 110.882567-0.511923 58.052092 42.540819 106.377643 98.289257 112.213568 2.406039 0.204769 4.863271 0.307154 7.371694 0.358346 60.662901 0.511923 110.06349-49.298205 110.626606-110.882567 0.511923-58.0009-42.592011-106.377643-98.289257-112.213568a108.886067 108.886067 0 0 0-7.371694-0.358346zM485.53357 0C570.819977 0 639.980803 71.566865 639.980803 159.822427c0 88.204369-69.109634 159.771234-154.447233 159.771234-85.337599 0-154.447233-71.566865-154.447233-159.771234C331.086337 71.566865 400.195971 0 485.53357 0zM154.524021 570.691996c85.337599 0 154.447233 71.566865 154.447233 159.822427s-69.109634 159.771234-154.447233 159.771234C69.237614 890.285657 0.076788 818.769985 0.076788 730.514423s69.109634-159.822427 154.447233-159.822427z"
                fill="#ffffff" p-id="8089"></path>
    </svg>
</div>

<div class="section-by-status" id="status-STARTING">
  服务器正在启动. 请稍等 ...
</div>

<div class="section-by-status" id="status-STARTED" style="display: none;">
  GoCD server has started. You will be automatically redirected to it in a few seconds. <a href="#" onclick="window.location.reload(true);">Go directly to the GoCD server.</a>
</div>

<div class="section-by-status" id="status-UNKNOWN" style="display: none;">
  Unable to contact the GoCD server. It might not have started. Please check the server logs.
</div>

<div id="update-check-message"></div>
</body>

<script type="text/javascript">
  // https://github.com/yanatan16/nanoajax/blob/cc89609d8f4a17a346b27e2f85c18e14de18a76b/nanoajax.min.js
  !function(t,e){function n(t){return t&&e.XDomainRequest&&!/MSIE 1/.test(navigator.userAgent)?new XDomainRequest:e.XMLHttpRequest?new XMLHttpRequest:void 0}function o(t,e,n){t[e]=t[e]||n}var r=["responseType","withCredentials","timeout","onprogress"];t.ajax=function(t,a){function s(t,e){return function(){c||(a(void 0===f.status?t:f.status,0===f.status?"Error":f.response||f.responseText||e,f),c=!0)}}var u=t.headers||{},i=t.body,d=t.method||(i?"POST":"GET"),c=!1,f=n(t.cors);f.open(d,t.url,!0);var l=f.onload=s(200);f.onreadystatechange=function(){4===f.readyState&&l()},f.onerror=s(null,"Error"),f.ontimeout=s(null,"Timeout"),f.onabort=s(null,"Abort"),i&&(o(u,"X-Requested-With","XMLHttpRequest"),e.FormData&&i instanceof e.FormData||o(u,"Content-Type","application/x-www-form-urlencoded"));for(var p,m=0,v=r.length;v>m;m++)p=r[m],void 0!==t[p]&&(f[p]=t[p]);for(var p in u)f.setRequestHeader(p,u[p]);return f.send(i),f},e.nanoajax=t}({},function(){return this}());
</script>

<script type="text/javascript">

  var intervalSizeInSeconds = 2;
  var numberOfIntervalsBetweenStatusUpdateCalls = 4;

  var hide = function hide(element) {
    element.style = "display: none";
  };

  var show = function show(element) {
    element.style = "display: inherit";
  };

  var updateMessage = function updateMessage(message) {
    document.getElementById("update-check-message").textContent = message;
  };

  var handleResponse = function handleResponse(status) {
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      var elements = document.getElementsByClassName("section-by-status");
      for (var i = 0; i < elements.length; i++) {
        hide(elements[i]);
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    show(document.getElementById("status-" + status));
  };

  var getStatus = function getStatus(callbackFn) {
    window.nanoajax.ajax({
      url: '/go/api/v1/health'
    }, function (code, responseText) {
      var status = "UNKNOWN";
      if (code === 200) {
        status = "STARTED";
      } else if (code === 503) {
        status = "STARTING";
      }

      callbackFn(status);
    });
  };

  var incrementingIndex = function () {
    var i = 0;
    return function () {
      return ++i;
    };
  }();

  var timer = setInterval(function () {
    var index = incrementingIndex();
    var nextCheck = (numberOfIntervalsBetweenStatusUpdateCalls - index % numberOfIntervalsBetweenStatusUpdateCalls) * intervalSizeInSeconds;

    updateMessage("(Next check in " + nextCheck + " seconds)");

    if (index % numberOfIntervalsBetweenStatusUpdateCalls !== 0) {
      return;
    }

    updateMessage("Checking ...");
    getStatus(function (status) {
      if (status === "STARTED") {
        updateMessage("");
        clearInterval(timer);
        setTimeout(function () {
          return window.location.reload(true);
        }, 4000);
      }
      handleResponse(status);
    });
  }, intervalSizeInSeconds * 1000);

</script>
</html>
